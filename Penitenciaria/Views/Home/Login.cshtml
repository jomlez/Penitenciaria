@{
    ViewData["Title"] = "Iniciar Sesión";
}

<div class="row justify-content-center mt-5">
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center">
                <h3>Acceso Penitenciaría</h3>
            </div>
            <div class="card-body">
                <form id="formLogin">
                    <div class="mb-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" id="txtUsuario" class="form-control" placeholder="Ej: admin01" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <input type="password" id="txtPassword" class="form-control" placeholder="******" required />
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Ingresar</button>
                    </div>
                    <div class="mt-3 text-center">
                        <a href="/Home/Registro">¿No tienes cuenta? Regístrate aquí</a>
                    </div>
                </form>
                <div id="mensajeError" class="alert alert-danger mt-3" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("formLogin").addEventListener("submit", async function (e) {
        e.preventDefault(); 
        const datos = {
            NombreUsuario: document.getElementById("txtUsuario").value,
            Contrasena: document.getElementById("txtPassword").value
        };

        try {
            const respuesta = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if (respuesta.ok) {
                const resultado = await respuesta.json();

                localStorage.setItem("tokenPenitenciaria", resultado.token);
                localStorage.setItem("usuario", resultado.usuario);

                alert("¡Bienvenido " + resultado.usuario + "!");
                window.location.href = "/Home/Index"; 
            } else {
                document.getElementById("mensajeError").innerText = "Usuario o contraseña incorrectos.";
                document.getElementById("mensajeError").style.display = "block";
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al intentar conectar con el servidor.");
        }
    });
</script>