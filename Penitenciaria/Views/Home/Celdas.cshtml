@{
    ViewData["Title"] = "Gestión de Celdas";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Gestión de Pabellones y Celdas</h2>

    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">
            Nueva Celda
        </div>
        <div class="card-body">
            <form id="formCelda" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Número/Nombre de Celda</label>
                    <input type="text" class="form-control" id="txtNumero" placeholder="Ej: A-101" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Capacidad de Reos</label>
                    <input type="number" class="form-control" id="txtCapacidad" min="1" max="50" value="4" required>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success">Guardar Celda</button>
                </div>
            </form>
            <div id="alerta" class="alert alert-info mt-3" style="display:none;"></div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            Listado de Celdas
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Número</th>
                        <th>Capacidad</th>
                        <th>Ocupación</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCeldas">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api/celdas';
    let rolUsuario = "";

    function obtenerToken() {
        return localStorage.getItem("tokenPenitenciaria");
    }

    document.addEventListener("DOMContentLoaded", function() {
        rolUsuario = localStorage.getItem("rol");
        cargarCeldas();
    });

    async function cargarCeldas() {
        const token = obtenerToken();
        if (!token) {
            window.location.href = "/Home/Login";
            return;
        }

        try {
            const respuesta = await fetch(API_URL, {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (respuesta.status === 401) {
                alert("Sesión expirada");
                window.location.href = "/Home/Login";
                return;
            }

            const celdas = await respuesta.json();
            const tabla = document.getElementById("tablaCeldas");
            tabla.innerHTML = "";

            celdas.forEach(celda => {
                const claseEstado = celda.ocupacionActual >= celda.capacidad ? "text-danger fw-bold" : "text-success";
                const textoEstado = celda.ocupacionActual >= celda.capacidad ? "LLENA" : "DISPONIBLE";

                let botonesAccion = "";
                if (rolUsuario === "Administrador" || rolUsuario === "Admin") {
                    botonesAccion = `
                        <button class="btn btn-sm btn-danger" onclick="eliminarCelda(${celda.celdaID})" title="Eliminar">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="alert('Editar pendiente')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                    `;
                } else {
                    botonesAccion = `<span class="text-muted small">Solo lectura</span>`;
                }

                const fila = `
                    <tr>
                        <td>${celda.celdaID}</td>
                        <td>${celda.numeroCelda}</td>
                        <td>${celda.capacidad}</td>
                        <td>${celda.ocupacionActual}</td>
                        <td class="${claseEstado}">${textoEstado}</td>
                        <td>${botonesAccion}</td>
                    </tr>
                `;
                tabla.innerHTML += fila;
            });
        } catch (error) {
            console.error("Error cargando celdas:", error);
        }
    }

    async function eliminarCelda(id) {
        if(!confirm("¿Estás seguro de eliminar esta celda?")) return;

        const token = obtenerToken();
        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if(res.ok) {
                alert("Eliminado correctamente");
                cargarCeldas();
            } else {
                const txt = await res.text();
                alert("Error al eliminar: " + txt);
            }
        } catch (error) {
            alert("Error de conexión");
        }
    }

    document.getElementById("formCelda").addEventListener("submit", async function(e) {
        e.preventDefault();
        const token = obtenerToken();
        const alerta = document.getElementById("alerta");

        const datos = {
            NumeroCelda: document.getElementById("txtNumero").value,
            Capacidad: parseInt(document.getElementById("txtCapacidad").value)
        };

        try {
            const respuesta = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(datos)
            });

            if (respuesta.ok) {
                alerta.className = "alert alert-success mt-3";
                alerta.innerText = "Celda agregada correctamente.";
                alerta.style.display = "block";
                document.getElementById("formCelda").reset();
                cargarCeldas();
            } else {
                const errorTxt = await respuesta.text();
                alerta.className = "alert alert-danger mt-3";
                alerta.innerText = "Error: " + errorTxt;
                alerta.style.display = "block";
            }
        } catch (error) {
            alerta.innerText = "Error de conexión.";
            alerta.style.display = "block";
        }

        setTimeout(() => { alerta.style.display = 'none'; }, 3000);
    });
</script>